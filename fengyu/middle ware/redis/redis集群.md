
## Redis集群方案

redis-cluster高可用架构方案是目前最好的redis架构方案，redis的官方对redis-cluster架构是建议redis-master用于接收读写，而redis-slave则用于备份（备用），默认不建议读写分离。

#### 节点通信
不同节点存储的数据相互独立，同步节点状态信息。

Gossip协议：
ping pong meet fail 

#### Redis故障转移
少量节点故障 自动故障转移 保证集群高可用

1. 主观下线
Redis集群内节点通过ping/pong消息实现节点通信。
cluster-node-timeout 内没有完成ping消息回复，标记该节点主观下线(pfail)，并将状态消息广播给其他节点

2. 主观下线后，通过gossip消息发送故障节点的下线报告。当半数以上持有槽的节点都标记某个节点主观下线后，触发客观下线流程，并向集群广播下线节点fail消息。

3，故障节点客观下线后，如果是持有槽的主节点，会从他的从节点中选出一个替换为主节点

资格检查：主从节点短线时间
`cluster-node-timeout * cluster-slave-validity-factor`

3.2 选举

配置纪元是一个只增不减的整数，每个主节点自身维护一个配置纪元，标示当前主节点的版本，所有主节点的配置纪元都不相等，从节点会复制主节点的配置纪元。整个集群又维护一个全局的配置纪元，用于记录集群内所有主节点配置纪元的最大版本。每次集群发生重大事件，如新加入主节点或由从节点转换而来，从节点竞争选举，都会递增集群全局配置纪元并赋值给相关主节点，用于记录这一关键事件


`slot 0~16383`
虚拟槽分区 `CRC16(key)%16383` 每个master节点负责一定范围的槽
moved重定向



