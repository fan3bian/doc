使用redis做为缓存，redis基本上是基于内存完成的操作，数据都在内存里。一旦redis服务宕机了，内存中数据将全部丢失，怎么保证数据不会丢失？

## redis持久化
redis持久化主要依靠两种机制：AOF日志和RDB快照。

#### AOF日志
Append Only File，类似于binlog，AOF日志是redis执行命令后，写入AOF。

###### AOF两个风险
1. 写入AOF日志不阻塞当前命令，AOF日志同样也是主线程执行，如果把日志文件写入磁盘，写入压力大，会阻塞下个操作
2. redis执行完命令后宕机，AOF日志没有写入磁盘，导致数据丢失

###### AOF写入磁盘策略
appendfsyncy用于配置AOF写入磁盘策略
- Always：同步写入
- EverySec：每秒写入，把日志写入AOF文件内存缓冲区，每秒把缓冲区内容写入磁盘。
- No：写入文件内存缓冲区，由操作系统控制写入磁盘。

trade-off: 性能和可靠性之间取舍，避免主线程阻塞

###### AOF文件重写机制
reids重写机制，可避免AOF文件过大
重写是通过bgwriteaof线程完成，不使用主线程，不会造成阻塞。
redis先进行内存拷贝，根据内存里数据最新状态，生成这些数据的插入命令，作为新日志。


Q:如果执行命令前写入有什么问题？
1. 命令可能执行失败 2. 命令错误(语法) 