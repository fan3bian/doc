## 采购单重构

#### 采购单现状
采购单创建下发业务：业务代码散乱在gateway isv seller等接口层(web端)中，相同的业务逻辑代码多处出现。在业务扩展延申的过程中，各个接口应用逐渐出现了功能遗漏，最终业务逻辑不一致的情况。
复杂的业务逻辑和散乱脆弱的代码无形中增加了开发运维的负担
#### 目标
鉴于采购单业务代码复杂混乱，对采购单整体重构，以达到业务逻辑清晰，代码高可用，业务组件可复用
#### 范围
采购单重构一期重构范围：采购单创建与下发
#### 细则

###### 设计思路
1. 不增加新应用，在原应用中新建PoBizService逐步替换poMainService poItemservice等jsf服务，po应用对外暴露的微服务接口不可超过5个。
2. isv gateway seller层不再保留采购单业务逻辑，只负责组织请求参数和接收请求结果。
3. 采用ICompenment组件实现功能，业务层不对接口层抛异常
4. 保持业务逻辑不变，根据商家做流量切换，逐步上线。
###### 采购单创建流程
1. 参数校验
2. 防并发(redis)
3. 事业部/商家/供应商校验
4. 仓库/物流服务校验
5. 采购单明细(商品校验)
6. 京配搜索/质检/越库校验
7. 采购单保存
8. 采购单下发
9. 采购单集合单
###### 组件划分
1. 货主信息组件
2. 物流服务组件
3. 采购明细组件
4. 京配搜索|质检|越库组件
5. 采购单保存组件(下发)
6. 集合单


#### 其他更改

1. 拟更改采购单“初始化”状态为“已下发库房”
2. 移除采购单质量检查
条件：1. 事业部质检服务标识 2.京东大件仓
说明：业务已不存在,移除质量检查相关代码
3. 移除计算单据毛重，计算多级包装体积重量的逻辑。采购单体积zhong
4. jd自营以及京东内配系统，自动拉取自营商品功能不整合入组件。
5. 移除序列号清单
6. 移除条码标识
7. 移除腾讯按箱收货
8. 采购单防重，isvPoNo和deptNo，面向创建(上游)防重
9. 移除muji集单功能
10. 


ediRemark:目前没什么用
orderAmount:订单金额,salce=2
grossWeight: kg,向上取整，重量非isv传递，来自明细计算，参照订单使用goodsExtend.grossWeight
volume: m3,向上取整，体积非isv传递，来自于明细计算



回归测试功能：
1.采购单浮点数功能：精度


#### 采购单接口层
接口层作为业务单据上一层接口，主要职责是组装业务层请求参数，接收业务层返回结果，组装成客户端返回数据。通常，接口层横向具有统一的出入参标准。而且，接口层对客户端暴露的接口，一旦定义下来，很难再修改。
它完全遵循开放封闭原则（OCP，Open Closed Principle)。所以，接口定义的越标准，前期规划的越准确越清晰，对于后续的扩展和运维，就越有利。多数系统的痛苦都可归罪于前期开发人的思虑不周，急功近利。

接口层通常需要解决的一项任务是：鉴权。

鉴权是出于系统安全性的需要，也是防止不合法的数据在业务系统中运行。接口层应努力把不合法的请求拦住，防止造成业务系统的灾难。在京东体系内，统一登陆认证确保了pin的安全。在云仓体系下，面向货主的接口层，dpet和pin的校验，确保了请求有权限使用于该事业部的权限极其与事业部有关的所有资源(店铺/库房/商品/承运商/物流服务)。报文的中资源的校验与业务关系密切，因为三个接口层并存(isv gateway seller),相同代码不应重复三份。而pin和dept的校验必须坐在接口层，因为要保证业务系统功能的专注，业务系统不应涉及任何账号权限相关的内容。目前在clps中，isv和gateway是不同标准的货主接口层，seller是web端。他们校验pin和dpet的方式也是不同的。




#### repeat

git remote set-url origin https://coding.jd.com/clps/clps-biz-po.git
